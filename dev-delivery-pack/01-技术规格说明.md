# æ°´å°äº§å“æŠ€æœ¯è§„æ ¼è¯´æ˜ä¹¦

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢å±‚                              â”‚
â”‚  React 18 + TypeScript + TailwindCSS                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ä¸šåŠ¡é€»è¾‘å±‚                              â”‚
â”‚  æ°´å°å¼•æ“ â†’ è¯ä¹¦ç³»ç»Ÿ â†’ æ€§èƒ½ä¼˜åŒ– â†’ å…¼å®¹æ€§å¤„ç†              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æ ¸å¿ƒç®—æ³•å±‚                              â”‚
â”‚  Canvas API + Web Crypto API + File API + Web Workers    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    æµè§ˆå™¨å…¼å®¹æ€§å±‚                          â”‚
â”‚  ç‰¹æ€§æ£€æµ‹ + Polyfill + é™çº§ç­–ç•¥                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ è¯¦ç»†æŠ€æœ¯è§„æ ¼

### 1. æ°´å°æ¸²æŸ“å¼•æ“

#### 1.1 æ–‡å­—æ°´å°å¼•æ“
```typescript
interface TextWatermarkConfig {
  text: string;
  fontSize: number;        // 8-72px
  fontFamily: string;      // ç³»ç»Ÿå­—ä½“åˆ—è¡¨
  color: string;          // RGB/RGBAæ ¼å¼
  opacity: number;        // 0-100%
  position: PositionType; // 9å®«æ ¼ä½ç½®
  rotation: number;       // -180Â° to 180Â°
  stroke?: {
    color: string;
    width: number;
  };
  shadow?: {
    color: string;
    blur: number;
    offset: { x: number; y: number };
  };
}
```

**æ¸²æŸ“ç®—æ³•**ï¼š
- ä½¿ç”¨Canvas 2D Contextçš„`fillText()`å’Œ`strokeText()`
- æ–‡å­—æŠ—é”¯é½¿ï¼š`ctx.imageSmoothingEnabled = true`
- æ€§èƒ½ä¼˜åŒ–ï¼šç¦»å±Canvasé¢„æ¸²æŸ“
- å†…å­˜ç®¡ç†ï¼šä½¿ç”¨åç«‹å³æ¸…ç†Canvaså¼•ç”¨

#### 1.2 å›¾ç‰‡æ°´å°å¼•æ“
```typescript
interface ImageWatermarkConfig {
  image: HTMLImageElement;
  scale: number;          // 10-200%
  opacity: number;        // 0-100%
  position: PositionType;
  rotation: number;
  blendMode: BlendMode;   // æ­£å¸¸/å åŠ /æŸ”å…‰ç­‰
}
```

**åˆæˆç®—æ³•**ï¼š
```typescript
// æ ¸å¿ƒåˆæˆé€»è¾‘
ctx.globalAlpha = opacity;
ctx.globalCompositeOperation = blendMode;
ctx.drawImage(watermarkImage, x, y, width, height);
```

### 2. è¯ä¹¦éªŒè¯ç³»ç»Ÿ

#### 2.1 SHA-256å“ˆå¸Œè®¡ç®—
```typescript
class CertificateGenerator {
  async generateCertificate(
    originalFile: File,
    watermarkConfig: WatermarkConfig
  ): Promise<Certificate> {
    const fileBuffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-256', fileBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    return {
      fileHash: hashHex,
      watermarkConfig: watermarkConfig,
      timestamp: Date.now(),
      version: '1.0.0'
    };
  }
}
```

#### 2.2 è¯ä¹¦æ•°æ®ç»“æ„
```typescript
interface Certificate {
  fileHash: string;           // SHA-256å“ˆå¸Œå€¼
  watermarkConfig: any;       // æ°´å°é…ç½®å¿«ç…§
  timestamp: number;          // Unixæ—¶é—´æˆ³
  version: string;           // è¯ä¹¦æ ¼å¼ç‰ˆæœ¬
  signature?: string;        // å¯é€‰çš„RSAç­¾å
}

interface VerificationResult {
  isValid: boolean;
  originalHash: string;
  currentHash: string;
  timestamp: number;
  message: string;
}
```

### 3. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 3.1 WebWorkerå®ç°
```typescript
// worker.ts
self.onmessage = async (e) => {
  const { imageData, watermarkConfig } = e.data;
  
  // åœ¨Workerä¸­å¤„ç†å›¾ç‰‡ï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹
  const processedImage = await processImage(imageData, watermarkConfig);
  
  self.postMessage({ processedImage });
};

// ä¸»çº¿ç¨‹ä½¿ç”¨
const worker = new Worker('/watermark-worker.js');
worker.postMessage({ imageData, config });
```

#### 3.2 å†…å­˜ä¼˜åŒ–
```typescript
class MemoryManager {
  private canvasPool: OffscreenCanvas[] = [];
  
  getCanvas(width: number, height: number): OffscreenCanvas {
    // ä»æ± å­ä¸­è·å–æˆ–åˆ›å»ºæ–°çš„Canvas
    const canvas = this.canvasPool.pop() || new OffscreenCanvas(width, height);
    canvas.width = width;
    canvas.height = height;
    return canvas;
  }
  
  releaseCanvas(canvas: OffscreenCanvas) {
    // æ¸…ç†å¹¶é‡ç½®Canvas
    const ctx = canvas.getContext('2d');
    ctx?.clearRect(0, 0, canvas.width, canvas.height);
    this.canvasPool.push(canvas);
  }
}
```

### 4. æµè§ˆå™¨å…¼å®¹æ€§

#### 4.1 ç‰¹æ€§æ£€æµ‹çŸ©é˜µ
```typescript
interface BrowserSupport {
  canvas: boolean;
  webCrypto: boolean;
  fileApi: boolean;
  webWorkers: boolean;
  offscreenCanvas: boolean;
}

const checkBrowserSupport = (): BrowserSupport => {
  return {
    canvas: !!window.HTMLCanvasElement,
    webCrypto: !!window.crypto?.subtle,
    fileApi: !!(window.File && window.FileReader && window.FileList && window.Blob),
    webWorkers: !!window.Worker,
    offscreenCanvas: typeof OffscreenCanvas !== 'undefined'
  };
};
```

#### 4.2 é™çº§ç­–ç•¥
```typescript
class CompatibilityManager {
  private supports = checkBrowserSupport();
  
  async processImage(file: File, config: WatermarkConfig): Promise<Blob> {
    if (this.supports.offscreenCanvas && this.supports.webWorkers) {
      return this.processWithWorker(file, config);
    } else {
      return this.processWithMainThread(file, config);
    }
  }
  
  private processWithMainThread(file: File, config: WatermarkConfig): Promise<Blob> {
    // ä¸»çº¿ç¨‹å¤„ç†ï¼Œé€‚åˆä¸æ”¯æŒWorkerçš„æµè§ˆå™¨
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        // å¤„ç†é€»è¾‘...
        resolve(canvas.toBlob()!);
      };
      img.src = URL.createObjectURL(file);
    });
  }
}
```

## ğŸ“Š æ€§èƒ½åŸºå‡†

### æ€§èƒ½æŒ‡æ ‡
| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| 1MBæ–‡ä»¶å¤„ç†æ—¶é—´ | â‰¤3ç§’ | Chrome DevTools Performance |
| å†…å­˜å³°å€¼ä½¿ç”¨ | â‰¤100MB | Chrome DevTools Memory |
| é¦–æ¬¡åŠ è½½æ—¶é—´ | â‰¤1ç§’ | Lighthouse |
| å¹¶å‘å¤„ç†èƒ½åŠ› | 5ä¸ªæ–‡ä»¶åŒæ—¶å¤„ç† | è‡ªå®šä¹‰æµ‹è¯• |

### æµ‹è¯•åœºæ™¯
```typescript
const performanceTests = [
  {
    name: '1MB JPEGå¤„ç†',
    fileSize: 1024 * 1024,
    format: 'image/jpeg',
    expectedTime: 3000 // æ¯«ç§’
  },
  {
    name: '5MB PNGå¤„ç†',
    fileSize: 5 * 1024 * 1024,
    format: 'image/png',
    expectedTime: 8000 // æ¯«ç§’
  },
  {
    name: 'æ‰¹é‡å¤„ç†',
    files: 5,
    size: 1024 * 1024,
    expectedTime: 15000 // æ¯«ç§’
  }
];
```

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. æ•°æ®å®‰å…¨
- **é›¶æœåŠ¡å™¨ä¼ è¾“**ï¼šæ‰€æœ‰å¤„ç†åœ¨æµè§ˆå™¨ç«¯å®Œæˆ
- **å†…å­˜æ¸…ç†**ï¼šå¤„ç†åç«‹å³é‡Šæ”¾æ•æ„Ÿæ•°æ®
- **è¯ä¹¦éªŒè¯**ï¼šé˜²æ­¢è¯ä¹¦ä¼ªé€ å’Œç¯¡æ”¹

### 2. è¾“å…¥éªŒè¯
```typescript
class InputValidator {
  static validateFile(file: File): ValidationResult {
    const maxSize = 10 * 1024 * 1024; // 10MB
    const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
    
    if (file.size > maxSize) {
      return { valid: false, error: 'æ–‡ä»¶å¤§å°è¶…è¿‡10MBé™åˆ¶' };
    }
    
    if (!allowedTypes.includes(file.type)) {
      return { valid: false, error: 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼' };
    }
    
    return { valid: true };
  }
  
  static validateWatermarkConfig(config: any): ValidationResult {
    // éªŒè¯é…ç½®å‚æ•°èŒƒå›´
    if (config.opacity < 0 || config.opacity > 100) {
      return { valid: false, error: 'é€æ˜åº¦å¿…é¡»åœ¨0-100ä¹‹é—´' };
    }
    
    return { valid: true };
  }
}
```

## ğŸ“ æ–‡ä»¶ç»“æ„è§„èŒƒ

### é¡¹ç›®ç»“æ„
```
src/
â”œâ”€â”€ components/          # Reactç»„ä»¶
â”‚   â”œâ”€â”€ WatermarkPanel/
â”‚   â”œâ”€â”€ ImagePreview/
â”‚   â””â”€â”€ CertificateViewer/
â”œâ”€â”€ services/           # æ ¸å¿ƒæœåŠ¡
â”‚   â”œâ”€â”€ WatermarkEngine.ts
â”‚   â”œâ”€â”€ CertificateService.ts
â”‚   â””â”€â”€ PerformanceService.ts
â”œâ”€â”€ utils/              # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ fileUtils.ts
â”‚   â”œâ”€â”€ canvasUtils.ts
â”‚   â””â”€â”€ validation.ts
â”œâ”€â”€ workers/            # Web Workers
â”‚   â””â”€â”€ watermark.worker.ts
â””â”€â”€ types/              # TypeScriptç±»å‹å®šä¹‰
    â””â”€â”€ watermark.types.ts
```

### å‘½åè§„èŒƒ
- **ç»„ä»¶**ï¼šPascalCase (WatermarkPanel)
- **å‡½æ•°**ï¼šcamelCase (processImage)
- **å¸¸é‡**ï¼šUPPER_SNAKE_CASE (MAX_FILE_SIZE)
- **æ–‡ä»¶**ï¼škebab-case (watermark-engine.ts)

## ğŸš€ éƒ¨ç½²é…ç½®

### æ„å»ºé…ç½®
```javascript
// vite.config.ts
export default defineConfig({
  build: {
    target: ['chrome80', 'firefox75', 'safari13'],
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ['react', 'react-dom'],
          utils: ['canvas-utils', 'file-utils']
        }
      }
    }
  },
  worker: {
    format: 'es'
  }
});
```

### CDNé…ç½®
```html
<!-- index.html -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preload" href="/watermark-worker.js" as="worker">
<link rel="preload" href="/fonts/system-fonts.css" as="style">
```

---

**ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•**
- [ ] TypeScriptç±»å‹å®šä¹‰å®Œæ•´
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡â‰¥80%
- [ ] æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•è¾¾æ ‡
- [ ] å®‰å…¨å®¡æŸ¥æ— æ¼æ´
- [ ] ä»£ç å®¡æŸ¥å®Œæˆ
- [ ] æ–‡æ¡£ç¼–å†™å®Œæ•´

**ğŸ¯ æŠ€æœ¯æ ˆç¡®è®¤**
- React 18.2.0
- TypeScript 5.0+
- Vite 4.0+
- TailwindCSS 3.0+
- æµè§ˆå™¨æ”¯æŒï¼šChrome 80+, Firefox 75+, Safari 13+